function Block(a,b){if(this.type=a,"undefined"==typeof b)switch(this.type){case BLOCK_TYPE.WIND:this.spreadLife=2;break;default:this.spreadLife=0}else this.spreadLife=b}function Grid(){this.width=20,this.height=10,this.tileSize=50,this.grid=[];for(var a=0;a<this.width;a++){this.grid[a]=[];for(var b=0;b<this.height;b++)this.grid[a][b]=null}}function Game(a){this.canvas=a,this.context=a.getContext("2d"),this.grid=new Grid,this.randomBlockEnabled=!0,this.nextBlockType=BLOCK_TYPE.EMPTY,this.currentLevel=0,this.currentState=GAME_STATE.START}var BLOCK_TYPE={NONE:0,WATER:1,EARTH:2,FIRE:3,WIND:4},NEIGHBOR_DIRECTION={LEFT:0,RIGHT:1,TOP:2,BOTTOM:3};Grid.prototype.placeBlock=function(a,b,c){this.grid[a][b]=c},Grid.prototype.removeBlock=function(a,b){this.grid[a][b]=null},Grid.prototype.isValidTile=function(a,b){return a>=0&&a<this.width&&b>=0&&b<this.height},Grid.prototype.canPlaceBlock=function(a,b){return this.isValidTile(a,b)&&null===this.grid[a][b]},Grid.prototype.getBlock=function(a,b){return this.isValidTile(a,b)?this.grid[a][b]:null},Grid.prototype.hasNeighborBlocks=function(a,b){var c=!1;return this.eachNeighborBlock(a,b,function(){c=!0}),c},Grid.prototype.eachNeighborBlock=function(a,b,c){var d=[],e=this.getBlock(a,b+1);d.push({x:a,y:b+1,block:e,direction:NEIGHBOR_DIRECTION.BOTTOM});var f=this.getBlock(a,b-1);d.push({x:a,y:b-1,block:f,direction:NEIGHBOR_DIRECTION.TOP});var g=this.getBlock(a-1,b);d.push({x:a-1,y:b,block:g,direction:NEIGHBOR_DIRECTION.LEFT});var h=this.getBlock(a+1,b);d.push({x:a+1,y:b,block:h,direction:NEIGHBOR_DIRECTION.RIGHT});for(var i=0;4>i;i++)if(null!=d[i].block){var j=d[i];c(j.x,j.y,j.block,j.direction)}},Grid.prototype.eachBlock=function(a){for(var b=[],c=0;c<this.width;c++)for(var d=0;d<this.height;d++)null!=this.grid[c][d]&&b.push({x:c,y:d,block:this.grid[c][d]});for(var e=b.length,f=0;e>f;f++){var g=b[f];a(g.x,g.y,g.block)}},Grid.prototype.getGridCoordinates=function(a,b){return{x:Math.floor(a/this.tileSize),y:Math.floor(b/this.tileSize)}},Grid.prototype.draw=function(a){var b=this.tileSize;a.fillStyle="#FFFFFF",a.fillRect(0,0,this.width*b,this.height*b),this.eachBlock(function(c,d,e){switch(e.type){case BLOCK_TYPE.FIRE:a.fillStyle="rgba(214, 30, 30, 1)";break;case BLOCK_TYPE.EARTH:a.fillStyle="rgba(196, 107, 33, 1)";break;case BLOCK_TYPE.WATER:a.fillStyle="rgba(33, 104, 196, 1)";break;case BLOCK_TYPE.WIND:a.fillStyle="rgba(112, 208, 230, 1)";break;default:a.fillStyle="rgba(1, 1, 1, 1)"}a.fillRect(c*b,d*b,b,b)})},Grid.prototype.update=function(){var a=this;this.eachBlock(function(b,c,d){var e=!1;if(a.eachNeighborBlock(b,c,function(f,g,h,i){return d.type===BLOCK_TYPE.EARTH&&h.type===BLOCK_TYPE.EARTH&&(e=!0),i!==NEIGHBOR_DIRECTION.BOTTOM||e||d.type!==BLOCK_TYPE.EARTH||h.type!==BLOCK_TYPE.WIND&&h.type!==BLOCK_TYPE.FIRE&&h.type!==BLOCK_TYPE.WATER?d.direction!=NEIGHBOR_DIRECTION.TOP&&d.type===BLOCK_TYPE.WATER&&h.type===BLOCK_TYPE.WIND?void a.removeBlock(f,g):d.type===BLOCK_TYPE.WATER&&h.type===BLOCK_TYPE.FIRE?void a.removeBlock(f,g):d.type===BLOCK_TYPE.FIRE&&h.type===BLOCK_TYPE.WIND?(a.removeBlock(f,g),void a.placeBlock(f,g,new Block(BLOCK_TYPE.FIRE))):void 0:void a.removeBlock(b,c+1)}),d.type===BLOCK_TYPE.WIND){if(d.spreadLife>0){var f=d.spreadLife-1;a.canPlaceBlock(b,c-1)&&a.placeBlock(b,c-1,new Block(BLOCK_TYPE.WIND,f)),a.canPlaceBlock(b,c+1)&&a.placeBlock(b,c+1,new Block(BLOCK_TYPE.WIND,f)),a.canPlaceBlock(b+1,c)&&a.placeBlock(b+1,c,new Block(BLOCK_TYPE.WIND,f)),a.canPlaceBlock(b-1,c)&&a.placeBlock(b-1,c,new Block(BLOCK_TYPE.WIND,f)),d.spreadLife=0}}else!e&&a.canPlaceBlock(b,c+1)?(a.removeBlock(b,c),a.placeBlock(b,c+1,d)):d.type===BLOCK_TYPE.WATER&&(a.canPlaceBlock(b+1,c)&&a.placeBlock(b+1,c,new Block(BLOCK_TYPE.WATER)),a.canPlaceBlock(b-1,c)&&a.placeBlock(b-1,c,new Block(BLOCK_TYPE.WATER)))})};var GAME_STATE={START:0,IN_LEVEL:1};Game.prototype.update=function(){this.grid.update()},Game.prototype.draw=function(){this.grid.draw(this.context)},Game.prototype.start=function(){function a(){b.update(),b.draw()}var b=this;b.canvas.addEventListener("click",function(a){b.handleClick(b,a)},!1),window.addEventListener("keydown",function(a){b.handleKeyPress(b,a)},!1),window.setInterval(a,100),a()},Game.prototype.handleClick=function(a,b){var c=b.x-a.canvas.offsetLeft,d=b.y-a.canvas.offsetTop,e=a.grid.getGridCoordinates(c,d);if(a.grid.canPlaceBlock(e.x,e.y)&&a.grid.hasNeighborBlocks(e.x,e.y)){var f=a.getNextBlockType(),g=new Block(f);grid.placeBlock(e.x,e.y,g)}},Game.prototype.handleKeyPress=function(a,b){switch(b.which){case 81:a.randomBlockEnabled=!1,a.nextBlockType=BLOCK_TYPE.EARTH;break;case 87:a.randomBlockEnabled=!1,a.nextBlockType=BLOCK_TYPE.WATER;break;case 69:a.randomBlockEnabled=!1,a.nextBlockType=BLOCK_TYPE.WIND;break;case 82:a.randomBlockEnabled=!1,a.nextBlockType=BLOCK_TYPE.FIRE;break;case 84:a.randomBlockEnabled=!0,a.nextBlockType=BLOCK_TYPE.EMPTY}},Game.prototype.getNextBlockType=function(){return this.randomBlockEnabled?Math.floor(4*Math.random())+1:nextBlockType};var game=new Game(document.getElementById("game"));game.start();