function Block(a,b){if(this.type=a,"undefined"==typeof b)switch(this.type){case BLOCK_TYPE.WIND:this.spreadLife=2;break;default:this.spreadLife=0}else this.spreadLife=b}function Grid(a){this.game=a,this.width=20,this.height=10,this.tileSize=50,this.grid=[];for(var b=0;b<this.width;b++){this.grid[b]=[];for(var c=0;c<this.height;c++)this.grid[b][c]=null}}function Game(a){this.canvas=a,this.context=a.getContext("2d"),this.grid=null,this.ui=new UserInterface(this),this.nextBlockType=BLOCK_TYPE.EARTH,this.currentLevel=0,this.currentState=GAME_STATE.START,this.tileCounts=[],this.tileCounts[BLOCK_TYPE.EARTH]=0,this.tileCounts[BLOCK_TYPE.WATER]=0,this.tileCounts[BLOCK_TYPE.FIRE]=0,this.tileCounts[BLOCK_TYPE.WIND]=0}function UserInterface(a){this.game=a,this.uiX=1e3,this.uiWidth=200,this.tileSelectionHeight=50,this.earthTileSelectionTopY=100,this.earthTileSelectionBottomY=this.earthTileSelectionTopY+this.tileSelectionHeight,this.waterTileSelectionTopY=150,this.waterTileSelectionBottomY=this.waterTileSelectionTopY+this.tileSelectionHeight,this.fireTileSelectionTopY=200,this.fireTileSelectionBottomY=this.fireTileSelectionTopY+this.tileSelectionHeight,this.windTileSelectionTopY=250,this.windTileSelectionBottomY=this.windTileSelectionTopY+this.tileSelectionHeight,this.resetTileSelectionTopY=450,this.resetTileSelectionBottomY=this.resetTileSelectionTopY+this.tileSelectionHeight}var LEVELS=[];LEVELS[0]=function(a){a.placeBlock(9,9,new Block(BLOCK_TYPE.VIRUS))},LEVELS[1]=function(a){a.placeBlock(7,9,new Block(BLOCK_TYPE.FIRE)),a.placeBlock(11,9,new Block(BLOCK_TYPE.VIRUS))};var BLOCK_TYPE={NONE:0,WATER:1,EARTH:2,FIRE:3,WIND:4,VIRUS:5},NEIGHBOR_DIRECTION={LEFT:0,RIGHT:1,TOP:2,BOTTOM:3};Grid.prototype.placeBlock=function(a,b,c){this.grid[a][b]=c},Grid.prototype.removeBlock=function(a,b){this.grid[a][b]=null},Grid.prototype.isValidTile=function(a,b){return a>=0&&a<this.width&&b>=0&&b<this.height},Grid.prototype.canPlaceBlock=function(a,b){return this.isValidTile(a,b)&&null===this.grid[a][b]},Grid.prototype.getBlock=function(a,b){return this.isValidTile(a,b)?this.grid[a][b]:null},Grid.prototype.eachNeighborBlock=function(a,b,c){var d=[],e=this.getBlock(a,b+1);d.push({x:a,y:b+1,block:e,direction:NEIGHBOR_DIRECTION.BOTTOM});var f=this.getBlock(a,b-1);d.push({x:a,y:b-1,block:f,direction:NEIGHBOR_DIRECTION.TOP});var g=this.getBlock(a-1,b);d.push({x:a-1,y:b,block:g,direction:NEIGHBOR_DIRECTION.LEFT});var h=this.getBlock(a+1,b);d.push({x:a+1,y:b,block:h,direction:NEIGHBOR_DIRECTION.RIGHT});for(var i=0;4>i;i++)if(null!=d[i].block){var j=d[i];c(j.x,j.y,j.block,j.direction)}},Grid.prototype.eachBlock=function(a){for(var b=[],c=0;c<this.width;c++)for(var d=0;d<this.height;d++)null!=this.grid[c][d]&&b.push({x:c,y:d,block:this.grid[c][d]});for(var e=b.length,f=0;e>f;f++){var g=b[f];a(g.x,g.y,g.block)}},Grid.prototype.getGridCoordinates=function(a,b){return{x:Math.floor(a/this.tileSize),y:Math.floor(b/this.tileSize)}},Grid.prototype.draw=function(a){var b=this.tileSize;a.fillStyle="#FFFFFF",a.fillRect(0,0,this.width*b,this.height*b),this.eachBlock(function(c,d,e){switch(e.type){case BLOCK_TYPE.FIRE:a.fillStyle="rgba(214, 30, 30, 1)";break;case BLOCK_TYPE.EARTH:a.fillStyle="rgba(196, 107, 33, 1)";break;case BLOCK_TYPE.WATER:a.fillStyle="rgba(33, 104, 196, 1)";break;case BLOCK_TYPE.WIND:a.fillStyle="rgba(112, 208, 230, 1)";break;case BLOCK_TYPE.VIRUS:a.fillStyle="rgba(77, 168, 37, 1)";break;default:a.fillStyle="rgba(1, 1, 1, 1)"}a.fillRect(c*b,d*b,b,b)})},Grid.prototype.update=function(){var a=this,b=!0;this.eachBlock(function(c,d,e){if(e.type===BLOCK_TYPE.VIRUS&&(b=!1),a.eachNeighborBlock(c,d,function(b,f,g,h){return h!==NEIGHBOR_DIRECTION.BOTTOM||e.type!==BLOCK_TYPE.EARTH||g.type!==BLOCK_TYPE.WIND&&g.type!==BLOCK_TYPE.FIRE&&g.type!==BLOCK_TYPE.WATER?e.direction!=NEIGHBOR_DIRECTION.TOP&&e.type===BLOCK_TYPE.WATER&&g.type===BLOCK_TYPE.WIND?void a.removeBlock(b,f):e.type===BLOCK_TYPE.WATER&&g.type===BLOCK_TYPE.FIRE?void a.removeBlock(b,f):e.type===BLOCK_TYPE.FIRE&&g.type===BLOCK_TYPE.WIND?(a.removeBlock(b,f),void a.placeBlock(b,f,new Block(BLOCK_TYPE.FIRE))):e.type===BLOCK_TYPE.VIRUS&&g.type===BLOCK_TYPE.FIRE?void a.removeBlock(c,d):void 0:void a.removeBlock(c,d+1)}),e.type===BLOCK_TYPE.WIND){if(e.spreadLife>0){var f=e.spreadLife-1;a.canPlaceBlock(c,d-1)&&a.placeBlock(c,d-1,new Block(BLOCK_TYPE.WIND,f)),a.canPlaceBlock(c,d+1)&&a.placeBlock(c,d+1,new Block(BLOCK_TYPE.WIND,f)),a.canPlaceBlock(c+1,d)&&a.placeBlock(c+1,d,new Block(BLOCK_TYPE.WIND,f)),a.canPlaceBlock(c-1,d)&&a.placeBlock(c-1,d,new Block(BLOCK_TYPE.WIND,f)),e.spreadLife=0}}else a.canPlaceBlock(c,d+1)?(a.removeBlock(c,d),a.placeBlock(c,d+1,e)):e.type===BLOCK_TYPE.WATER&&(a.canPlaceBlock(c+1,d)&&a.placeBlock(c+1,d,new Block(BLOCK_TYPE.WATER)),a.canPlaceBlock(c-1,d)&&a.placeBlock(c-1,d,new Block(BLOCK_TYPE.WATER)))}),b&&this.game.handleWinLevel()};var GAME_STATE={START:0,IN_LEVEL:1};Game.prototype.update=function(){switch(this.currentState){case GAME_STATE.START:this.setUpLevel(this.currentLevel);break;case GAME_STATE.IN_LEVEL:this.grid.update()}},Game.prototype.draw=function(){switch(this.currentState){case GAME_STATE.IN_LEVEL:this.grid.draw(this.context),this.ui.draw(this.context)}},Game.prototype.start=function(){function a(){b.update(),b.draw()}var b=this;b.canvas.addEventListener("click",function(a){b.handleClick(b,a)},!1),window.setInterval(a,100),a()},Game.prototype.handleClick=function(a,b){var c=b.x-a.canvas.offsetLeft,d=b.y-a.canvas.offsetTop;if(c>1e3)a.ui.handleClick(c,d);else{var e=a.grid.getGridCoordinates(c,d);if(a.grid.canPlaceBlock(e.x,e.y)){var f=a.getNextBlockType(),g=new Block(f);a.grid.placeBlock(e.x,e.y,g)}}},Game.prototype.getNextBlockType=function(){return this.nextBlockType},Game.prototype.handleSelectBlockType=function(a){this.nextBlockType=a},Game.prototype.handleResetLevel=function(){this.setUpLevel(this.currentLevel)},Game.prototype.handleWinLevel=function(){this.setUpLevel(++this.currentLevel)},Game.prototype.setUpLevel=function(a){this.grid=new Grid(this),LEVELS[a](this.grid),this.currentState=GAME_STATE.IN_LEVEL},UserInterface.prototype.handleClick=function(a,b){b>this.earthTileSelectionTopY&&b<this.earthTileSelectionBottomY&&this.game.handleSelectBlockType(BLOCK_TYPE.EARTH),b>this.waterTileSelectionTopY&&b<this.waterTileSelectionBottomY&&this.game.handleSelectBlockType(BLOCK_TYPE.WATER),b>this.fireTileSelectionTopY&&b<this.fireTileSelectionBottomY&&this.game.handleSelectBlockType(BLOCK_TYPE.FIRE),b>this.windTileSelectionTopY&&b<this.windTileSelectionBottomY&&this.game.handleSelectBlockType(BLOCK_TYPE.WIND),b>this.resetTileSelectionTopY&&b<this.resetTileSelectionBottomY&&this.game.handleResetLevel()},UserInterface.prototype.draw=function(a){a.fillStyle="#111",a.fillRect(1e3,0,200,500),a.fillStyle="#FFF",a.font="40px Arial, sans-serif",a.fillText("elum",1020,70),a.fillStyle="rgba(196, 107, 33, 1)",a.fillRect(this.uiX,this.earthTileSelectionTopY,this.uiWidth,this.tileSelectionHeight),a.fillStyle="rgba(255, 255, 255, 0.1)",a.fillRect(this.uiX,this.earthTileSelectionTopY,10,this.tileSelectionHeight),a.fillStyle="#FFF",a.font="18px Arial, sans-serif",a.fillText(this.game.tileCounts[BLOCK_TYPE.EARTH],1180,140),a.fillStyle="rgba(33, 104, 196, 1)",a.fillRect(1e3,this.waterTileSelectionTopY,200,50),a.fillStyle="rgba(255, 255, 255, 0.1)",a.fillRect(1e3,this.waterTileSelectionTopY,10,50),a.fillStyle="#FFF",a.font="18px Arial, sans-serif",a.fillText(this.game.tileCounts[BLOCK_TYPE.WATER],1180,190),a.fillStyle="rgba(214, 30, 30, 1)",a.fillRect(1e3,this.fireTileSelectionTopY,200,50),a.fillStyle="rgba(255, 255, 255, 0.1)",a.fillRect(1e3,this.fireTileSelectionTopY,10,50),a.fillStyle="#FFF",a.font="18px Arial, sans-serif",a.fillText(this.game.tileCounts[BLOCK_TYPE.FIRE],1180,240),a.fillStyle="rgba(112, 208, 230, 1)",a.fillRect(1e3,this.windTileSelectionTopY,200,50),a.fillStyle="rgba(255, 255, 255, 0.1)",a.fillRect(1e3,this.windTileSelectionTopY,10,50),a.fillStyle="#FFF",a.font="18px Arial, sans-serif",a.fillText(this.game.tileCounts[BLOCK_TYPE.WIND],1180,290),a.fillStyle="#FFF",a.font="15px Arial, sans-serif",a.fillText("level "+this.game.currentLevel,1020,340),a.fillStyle="rgba(255, 255, 255, 0.1)",a.fillRect(1e3,this.resetTileSelectionTopY,200,50),a.fillStyle="rgba(255, 255, 255, 0.1)",a.fillRect(1e3,this.resetTileSelectionTopY,10,50),a.fillStyle="#FFF",a.font="18px Arial, sans-serif",a.fillText("reset",1030,480)};var game=new Game(document.getElementById("game"));game.start();