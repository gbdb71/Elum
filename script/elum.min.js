function Block(a,b){switch(this.type=a,this.tileSize=50,this.type){case BLOCK_TYPE.FIRE:this.maxHealth=500;break;case BLOCK_TYPE.WIND:this.maxHealth=10;break;case BLOCK_TYPE.WATER:this.maxHealth=70;break;default:this.maxHealth=100}if("undefined"!=typeof b&&"undefined"!=typeof b.spreadLife)this.spreadLife=b.spreadLife;else switch(this.type){case BLOCK_TYPE.WIND:this.spreadLife=2;break;case BLOCK_TYPE.WATER:this.spreadLife=4;break;default:this.spreadLife=0}this.health=this.maxHealth}function drawRoundedSquare(a,b,c,d,e){a.beginPath(),a.moveTo(b,c+d),a.lineTo(b,c+e-d),a.quadraticCurveTo(b,c+e,b+d,c+e),a.lineTo(b+e-d,c+e),a.quadraticCurveTo(b+e,c+e,b+e,c+e-d),a.lineTo(b+e,c+d),a.quadraticCurveTo(b+e,c,b+e-d,c),a.lineTo(b+d,c),a.quadraticCurveTo(b,c,b,c+d),a.fill()}function Grid(a){this.game=a,this.width=20,this.height=10,this.grid=[],this.tileSize=50;for(var b=0;b<this.width;b++){this.grid[b]=[];for(var c=0;c<this.height;c++)this.grid[b][c]=null}}function Game(a){this.canvas=a,this.context=a.getContext("2d"),this.grid=new Grid(this),this.ui=new UserInterface(this),this.nextBlockType,this.virusTimer=0,this.virusDropInterval=100,this.currentToxicity=0}function UserInterface(a){this.game=a,this.uiX=1e3,this.uiWidth=200,this.tileSelectionHeight=50,this.nextBlockType}var BLOCK_TYPE={NONE:0,WATER:1,EARTH:2,FIRE:3,WIND:4,VIRUS:5};Block.prototype.draw=function(a,b,c){var d=this.health/this.maxHealth;switch(this.type){case BLOCK_TYPE.FIRE:a.fillStyle="rgba(214, 30, 30, "+d+")";break;case BLOCK_TYPE.EARTH:a.fillStyle="rgba(196, 107, 33, "+d+")";break;case BLOCK_TYPE.WATER:a.fillStyle="rgba(33, 104, 196, "+d+")";break;case BLOCK_TYPE.WIND:a.fillStyle="rgba(112, 208, 230, "+d+")";break;case BLOCK_TYPE.VIRUS:a.fillStyle="rgba(77, 168, 37, "+d+")";break;default:a.fillStyle="rgba(1, 1, 1, "+d+")"}var e=8,f=b*this.tileSize,g=c*this.tileSize;drawRoundedSquare(a,f,g,e,this.tileSize),a.fillStyle="rgba(1, 1, 1, 0.08)",drawRoundedSquare(a,f+5,g+5,e,this.tileSize-10)};var NEIGHBOR_DIRECTION={LEFT:0,RIGHT:1,TOP:2,BOTTOM:3};Grid.prototype.placeBlock=function(a,b,c){this.grid[a][b]=c},Grid.prototype.removeBlock=function(a,b){this.grid[a][b]=null},Grid.prototype.isValidTile=function(a,b){return a>=0&&a<this.width&&b>=0&&b<this.height},Grid.prototype.canPlaceBlock=function(a,b){return this.isValidTile(a,b)&&null===this.grid[a][b]},Grid.prototype.getBlock=function(a,b){return this.isValidTile(a,b)?this.grid[a][b]:null},Grid.prototype.eachNeighborBlock=function(a,b,c){var d=[],e=this.getBlock(a,b+1);d.push({x:a,y:b+1,block:e,direction:NEIGHBOR_DIRECTION.BOTTOM});var f=this.getBlock(a,b-1);d.push({x:a,y:b-1,block:f,direction:NEIGHBOR_DIRECTION.TOP});var g=this.getBlock(a-1,b);d.push({x:a-1,y:b,block:g,direction:NEIGHBOR_DIRECTION.LEFT});var h=this.getBlock(a+1,b);d.push({x:a+1,y:b,block:h,direction:NEIGHBOR_DIRECTION.RIGHT});for(var i=0;4>i;i++)if(null!=d[i].block){var j=d[i];c(j.x,j.y,j.block,j.direction)}},Grid.prototype.eachBlock=function(a){for(var b=[],c=0;c<this.width;c++)for(var d=0;d<this.height;d++)null!=this.grid[c][d]&&b.push({x:c,y:d,block:this.grid[c][d]});for(var e=b.length,f=0;e>f;f++){var g=b[f];a(g.x,g.y,g.block)}},Grid.prototype.getGridCoordinates=function(a,b){return{x:Math.floor(a/this.tileSize),y:Math.floor(b/this.tileSize)}},Grid.prototype.draw=function(a){var b=this.tileSize;a.fillStyle="#FFFFFF",a.fillRect(0,0,this.width*b,this.height*b),this.eachBlock(function(b,c,d){d.draw(a,b,c)})},Grid.prototype.update=function(){var a=this,b=0;this.eachBlock(function(c,d,e){if(e.type===BLOCK_TYPE.VIRUS&&b++,(e.type===BLOCK_TYPE.FIRE||e.type===BLOCK_TYPE.WIND||e.type===BLOCK_TYPE.WATER)&&e.health--,a.eachNeighborBlock(c,d,function(b,f,g,h){return h!==NEIGHBOR_DIRECTION.BOTTOM||e.type!==BLOCK_TYPE.EARTH||g.type!==BLOCK_TYPE.WIND&&g.type!==BLOCK_TYPE.FIRE&&g.type!==BLOCK_TYPE.WATER?h===NEIGHBOR_DIRECTION.BOTTOM&&e.type===BLOCK_TYPE.WATER&&g.type===BLOCK_TYPE.WATER?void a.removeBlock(b,f):h!=NEIGHBOR_DIRECTION.TOP&&e.type===BLOCK_TYPE.WATER&&g.type===BLOCK_TYPE.WIND?void a.removeBlock(c,d):e.type===BLOCK_TYPE.WATER&&g.type===BLOCK_TYPE.FIRE?void a.removeBlock(b,f):e.type===BLOCK_TYPE.FIRE&&g.type===BLOCK_TYPE.WIND?(a.removeBlock(b,f),void a.placeBlock(b,f,new Block(BLOCK_TYPE.FIRE))):e.type===BLOCK_TYPE.VIRUS&&g.type===BLOCK_TYPE.WATER?(a.removeBlock(b,f),void a.placeBlock(b,f,new Block(BLOCK_TYPE.VIRUS))):e.type===BLOCK_TYPE.VIRUS&&g.type===BLOCK_TYPE.FIRE?(a.removeBlock(c,d),void a.removeBlock(b,f)):e.type===BLOCK_TYPE.EARTH&&g.type===BLOCK_TYPE.WATER?void e.health--:void 0:void a.removeBlock(c,d+1)}),e.health<=0&&a.removeBlock(c,d),e.type===BLOCK_TYPE.WIND){if(e.spreadLife>0){var f=e.spreadLife-1;a.canPlaceBlock(c,d-1)&&a.placeBlock(c,d-1,new Block(BLOCK_TYPE.WIND,{spreadLife:f})),a.canPlaceBlock(c,d+1)&&a.placeBlock(c,d+1,new Block(BLOCK_TYPE.WIND,{spreadLife:f})),a.canPlaceBlock(c+1,d)&&a.placeBlock(c+1,d,new Block(BLOCK_TYPE.WIND,{spreadLife:f})),a.canPlaceBlock(c-1,d)&&a.placeBlock(c-1,d,new Block(BLOCK_TYPE.WIND,{spreadLife:f})),e.spreadLife=0}}else if(a.canPlaceBlock(c,d+1))a.removeBlock(c,d),a.placeBlock(c,d+1,e);else if(e.spreadLife>0){var f=e.spreadLife-1;e.type===BLOCK_TYPE.WATER&&(a.canPlaceBlock(c+1,d)&&a.placeBlock(c+1,d,new Block(BLOCK_TYPE.WATER,{spreadLife:f})),a.canPlaceBlock(c-1,d)&&a.placeBlock(c-1,d,new Block(BLOCK_TYPE.WATER,{spreadLife:f}))),e.spreadLife=0}}),this.game.updateVirusCount(b)},Game.prototype.update=function(){if(this.grid.update(),this.virusTimer++,this.virusTimer>this.virusDropInterval){var a=Math.floor(Math.random()*this.grid.width);this.grid.canPlaceBlock(a,0)&&this.grid.placeBlock(a,0,new Block(BLOCK_TYPE.VIRUS)),this.virusTimer=0}},Game.prototype.draw=function(){this.grid.draw(this.context),this.ui.draw(this.context)},Game.prototype.start=function(){function a(){b.update(),b.draw()}var b=this;b.canvas.addEventListener("click",function(a){b.handleClick(b,a)},!1),b.updateBlockType(),window.setInterval(a,100),a()},Game.prototype.handleClick=function(a,b){var c=b.x-a.canvas.offsetLeft,d=b.y-a.canvas.offsetTop;if(c>1e3)a.ui.handleClick(c,d);else{var e=a.grid.getGridCoordinates(c,d);if(a.grid.canPlaceBlock(e.x,e.y)){var f=new Block(a.nextBlockType);a.grid.placeBlock(e.x,e.y,f),a.updateBlockType()}}},Game.prototype.updateBlockType=function(){this.nextBlockType=Math.floor(4*Math.random()+1),this.ui.nextBlockType=this.nextBlockType},Game.prototype.updateVirusCount=function(a){this.currentToxicity=Math.floor(a/20*100),this.currentToxicity>=100&&this.handleLose()},Game.prototype.handleLose=function(){console.log("LOSE CONDITION")},UserInterface.prototype.handleClick=function(){},UserInterface.prototype.draw=function(a){a.fillStyle="#111",a.fillRect(1e3,0,200,500),a.fillStyle="#FFF",a.font="40px Arial, sans-serif",a.fillText("elum",1020,70);var b;switch(this.nextBlockType){case BLOCK_TYPE.FIRE:a.fillStyle="rgba(214, 30, 30, 1)",b="fire";break;case BLOCK_TYPE.EARTH:a.fillStyle="rgba(196, 107, 33, 1)",b="earth";break;case BLOCK_TYPE.WATER:a.fillStyle="rgba(33, 104, 196, 1)",b="water";break;case BLOCK_TYPE.WIND:a.fillStyle="rgba(112, 208, 230, 1)",b="wind"}a.fillRect(this.uiX,100,this.uiWidth,this.tileSelectionHeight),a.fillStyle="rgba(255, 255, 255, 0.1)",a.fillRect(this.uiX,100,10,this.tileSelectionHeight),a.fillStyle="#FFF",a.font="16px Arial, sans-serif",a.fillText(b,1020,140),a.fillStyle="#FFF",a.font="14px Arial, sans-serif",a.fillText("toxicity "+this.game.currentToxicity+"%",1020,190)};var game=new Game(document.getElementById("game"));game.start();